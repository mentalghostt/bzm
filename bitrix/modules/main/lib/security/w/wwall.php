<? namespace Bitrix\Main\Security\W;$GLOBALS['____1992152945']= array(base64_decode('dGltZQ=='),base64_decode('dGl'.'tZQ'.'=='),base64_decode('anNv'.'bl9kZWNvZG'.'U='),base64_decode('Y'.'XJyYXl'.'fbW'.'VyZ2U='),base64_decode('am9pbg=='),base64_decode('am'.'9p'.'bg=='),base64_decode('am9pbg=='),base64_decode('YXJyYXlfcG9w'),base64_decode('YXJyYXl'.'f'.'c'.'2h'.'pZn'.'Q='),base64_decode(''.'YXJyYXlfc2'.'hpZ'.'nQ='),base64_decode('YXJyYXlfc'.'2hpZ'.'nQ='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode(''.'YXJyYXlfbWVy'.'Z'.'2U'.'='),base64_decode('aXNfYX'.'JyY'.'Xk='),base64_decode(''.'Y'.'X'.'JyYX'.'lfbWVyZ2'.'U'.'='),base64_decode('aW5fYXJy'.'YXk='),base64_decode(''.'aW5fYXJy'.'YXk='),base64_decode('a'.'W5fYXJ'.'yYXk='),base64_decode('aW5fYXJyY'.'Xk='),base64_decode('a'.'W5fYXJyYXk'.'='),base64_decode(''.'dG'.'ltZQ=='),base64_decode(''.'dGltZQ=='),base64_decode(''.'YXJyYX'.'lfbWFw'),base64_decode('Z2V0X2'.'xvYWR'.'lZF9leHRlbnNpb25'.'z'),base64_decode('anNvbl9lbm'.'NvZGU='),base64_decode('a'.'nN'.'vb'.'l'.'9lbmNvZ'.'G'.'U='),base64_decode(''.'cGh'.'w'.'dmVyc2lv'.'b'.'g'.'=='),base64_decode('anNv'.'bl9lbmNvZG'.'U'.'='),base64_decode('am9p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___293823116')){function ___293823116($_1246688617){static $_361487772= false; if($_361487772 == false) $_361487772=array('V1dB'.'TE'.'xfTE'.'9DSw==',''.'c'.'2VjdXJp'.'d'.'Hk'.'=','REFUQQ==','eyI=','V1dBTExfTE9DSw==',''.'c'.'2V'.'jdXJpd'.'Hk'.'=','U0VDVVJJV'.'F'.'lfV1'.'dBTE'.'xfRV'.'hDR'.'VBUSU9O','RkFJTF9D'.'SEVDS'.'0lORw==',''.'Q2Fu'.'IG'.'5vd'.'CBleGV'.'j'.'dX'.'Rl'.'IHd'.'3Y'.'WxsIHJ1bGV'.'z'.'OiA'.'=','IFRyYWNl'.'OiA=','UkVR'.'VUV'.'T'.'VF9V'.'Ukk'.'=','a2V'.'5cw==','d'.'mFs'.'dW'.'Vz','U0VDVV'.'JJ'.'VFlfV1'.'d'.'BTEx'.'fTU'.'9'.'ESU'.'ZZ','Lg==','U'.'0VDVVJJVFlfV1'.'dBT'.'Ex'.'fVU5'.'TRVQ=','Lg==','U0'.'VDV'.'VJ'.'JVFlfV1dBT'.'ExfRV'.'hJVA==',''.'Lg==','Z'.'2xvYmFs','a2V5cw==','dmFs'.'dWV'.'z','Z2V0','Z2V'.'0','cG9zd'.'A'.'==',''.'cG'.'9zdA'.'==','Y29v'.'a2'.'ll','Y29'.'va'.'2l'.'l','cm'.'VxdWVzdA==','cm'.'Vxd'.'WVz'.'dA==','Z'.'2x'.'vYm'.'F'.'s','Z2'.'xvY'.'mF'.'s','bW'.'Fpbl9zZWM=','V1'.'d'.'B'.'T'.'Ex'.'fQUNUVUFM'.'SVpFX1'.'JVTEVT','dg='.'=','dm'.'Vyc2lvbg==','aQ='.'=','aXNJ'.'b'.'nN0YWxsZWQ=','dg'.'==','aW5p',''.'bW9kd'.'Wxlcw==','bGlj'.'ZW'.'5z'.'ZQ==','c'.'Ghw','dg'.'==','ZXh0',''.'c2'.'Vj'.'d'.'XJpdHk=','ZG'.'I=','dHlw'.'ZQ==','ZGI=','dmVyc2lvbg='.'=','ZGI=','dH'.'lwZQ'.'='.'=','ZGI'.'=','dHlwZQ='.'=',''.'dmVyc'.'2l'.'vbg'.'==','ZG'.'I=','d'.'mVyc2'.'lv'.'bg==','ZW52aXJvb'.'m'.'1'.'lb'.'n'.'Q'.'=','dm1fdmVyc2lvb'.'g==','dm0=','dg==','ZW52aXJv'.'b'.'m1'.'l'.'bnQ=',''.'dm1f'.'dmVyc2l'.'vb'.'g==','c'.'29ja2V0V'.'Gl'.'tZW91dA==',''.'c3RyZWFtVGlt'.'ZW9'.'1dA==','KCc=','Z'.'GF0YQ'.'==','JywgJw'.'='.'=','b'.'W9kdWxl','Jyw'.'gJw==','bW9'.'kdWxlX3'.'ZlcnNpb24=','Jyk'.'=','LCA=','U'.'0VDVVJJV'.'F'.'l'.'f'.'V1dBTExfRVhDRVBUSU9O','bW'.'Fpbg='.'=','RkF'.'JTF9'.'SR'.'UZSRVNISU5H','Q'.'2F'.'uIG'.'5vd'.'CB'.'yZWZyZ'.'XNoIHd3'.'YWxsIHJ1b'.'G'.'VzOiA=','IFRyYWNlOiA=','ZGF0YQ==','eyI'.'=','LS0tLS1C'.'RUdJTiBQ'.'VUJMSUMgS0VZLS0tLS0=',''.'Ck1JSUJ'.'J'.'akFO'.'QmdrcWhraUc5d'.'zBCQ'.'VFFRkFBT0N'.'BUThBTUl'.'JQkNnS0'.'NBUUVBcTh'.'RRT'.'BIam1ISl'.'VTd'.'F'.'dWNm4'.'we'.'mEKUlZv'.'THgw'.'Mkt'.'6'.'Y'.'mZyYlMv'.'UDZzV'.'2F'.'4VHp3OFN'.'lR1R0'.'YlR'.'DT3JwSGk1UUY2T'.'1J'.'5alo'.'vWH'.'h6L0t'.'MV'.'TFHYm9mOUNaMwo'.'0e'.'jdTa3FVdDY2'.'aWJYdk9GQng0'.'ZncvQVBQUkdEcXRt'.'M'.'G'.'5EM'.'2ZnR3N1'.'M1Jl'.'UG'.'d3MjlpO'.'Ct2bTd'.'t'.'dEJLSl'.'VZbD'.'Ry'.'ClZwYjZ'.'z'.'Zl'.'p'.'FVDlLR'.'W'.'I2VDFI'.'R'.'Fl'.'tR'.'XZ'.'jMW'.'hxL2'.'lpdX'.'l4THJaWmk1U'.'TZVZmY0VUV2V'.'E'.'kr'.'N'.'j'.'h'.'zc0ZSa1'.'E'.'rb3'.'dUUnk'.'K'.'Z'.'U9'.'JTWJG'.'aE0v'.'VVR'.'tZlZZ'.'Y'.'lR'.'SRnky'.'b1VROFdNemEybko1U2Fo'.'emkxVUtPMWpBal'.'hUU'.'FJyemM3QWp1N'.'jM'.'5ajFP'.'M'.'ApwcHFmbTV4Z1d'.'sRkFKa0h'.'RVGdiZGQ1QVd'.'x'.'REZ'.'Ra'.'3Q'.'5'.'SEtrWStUbmZCT'.'Ed'.'WTXZ'.'WeVB3V'.'EhO'.'V1FZQ'.'Xc0'.'eHBnL3dBClp3SU'.'RBUUFC'.'Ci0tLS0tRU5EIFBVQkxJ'.'QyBLRVk'.'tL'.'S0tLQ==');return base64_decode($_361487772[$_1246688617]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_453572466= 'https://wwall.bitrix.info/rules.php'; protected $_1123997673= true; public function handle(){ try{  $_1771240264= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1771240264)){ return;}  $_1430090954= Cache::createInstance(); $_281307757= false; if($_1430090954->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_2060072883= $_1430090954->getVars(); if($GLOBALS['____1992152945'][0]()- $_2060072883> round(0+6.6666666666667+6.6666666666667+6.6666666666667)){  $_326105303= Application::getConnection(); $_1908957546= RuleRecordTable::getTableName(); $_326105303->truncateTable($_1908957546); RuleRecordTable::cleanCache(); $_1430090954->clean(___293823116(0), ___293823116(1));}} elseif($_1430090954->startDataCache()){  $_1430090954->endDataCache($GLOBALS['____1992152945'][1]()); $_281307757= true;} foreach($_1771240264 as $_2131668573){ $_2025186515= new PublicKeyCipher; $_1365458107= $_2025186515->decrypt($_2131668573[___293823116(2)], static::__1811854996()); if(!str_starts_with($_1365458107, ___293823116(3))){ continue;} $_2146206264= $GLOBALS['____1992152945'][2]($_1365458107, true); if(!empty($_2146206264)){ $_530258179= Rule::make($_2146206264); $_315448752= $this->handleRule($_530258179); $this->applyHandlingResults($_315448752);}}  if($_281307757){ $_1430090954->clean(___293823116(4), ___293823116(5));}} catch(\Throwable $_1210173245){ $this->logEvent( ___293823116(6), ___293823116(7), ___293823116(8). $_1210173245->getMessage(). ___293823116(9). $_1210173245->getTraceAsString());}}  public function handleRule(Rule $_530258179): array{ $_315448752=[]; if($_530258179->matchPath($_SERVER[___293823116(10)])){  $_1180195727= $this->getContextElements($_530258179->getContext()); foreach($_1180195727 as $_34787650 => &$_2107821457){ $_315448752= $GLOBALS['____1992152945'][3]($_315448752, $this->recursiveContextKeyHandle($_34787650, $_2107821457,[], $_530258179));}} return $_315448752;}  public function applyHandlingResults(array $_315448752){ $_1180195727= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_315448752 as $_945107951){ $_2107821457=& $_1180195727[$_945107951->getContextName()]; $_1180705614= $_945107951->getRuleResult(); $_530258179= $_945107951->getRule(); if($_1180705614 instanceof ModifyResult){ if($_530258179->getProcess() === ___293823116(11)){  static::rewriteContextKey( $_945107951->getContextName(), $_2107821457, $_945107951->getContextKey(), $_1180705614->getCleanValue());} elseif($_530258179->getProcess() === ___293823116(12)){ static::rewriteContextValue( $_945107951->getContextName(), $_2107821457, $_945107951->getContextKey(), $_1180705614->getCleanValue());} $this->logEvent( ___293823116(13), $_945107951->getContextName(), $GLOBALS['____1992152945'][4](___293823116(14), $_945107951->getContextKey()));} elseif($_1180705614 instanceof CheckResult &&!$_1180705614->isSuccess()){ if($_1180705614->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_945107951->getContextName(), $_2107821457, $_945107951->getContextKey(),); $this->logEvent( ___293823116(15), $_945107951->getContextName(), $GLOBALS['____1992152945'][5](___293823116(16), $_945107951->getContextKey()));} elseif($_1180705614->getAction() === RuleAction::EXIT){ $this->logEvent( ___293823116(17), $_945107951->getContextName(), $GLOBALS['____1992152945'][6](___293823116(18), $_945107951->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1123997673= false;} protected function rewriteContextKey($_34787650, &$_2107821457, $_840782132, $_1675058400){ $_678037132= $_840782132;  $GLOBALS['____1992152945'][7]($_678037132); $_678037132[]= $_1675058400; if($_34787650 === ___293823116(19)){ $_1688925901= $GLOBALS['____1992152945'][8]($_840782132); $GLOBALS['____1992152945'][9]($_678037132); if(empty($_840782132)){ $GLOBALS[$_1675058400]= $GLOBALS[$_1688925901]; unset($GLOBALS[$_1688925901]);} else{ $_2107821457=& $GLOBALS[$_1688925901]; $_1761518185= ArrayHelper::getByNestedKey($_2107821457, $_840782132);  ArrayHelper::setByNestedKey($_2107821457, $_678037132, $_1761518185);  ArrayHelper::unsetByNestedKey($_2107821457, $_840782132);}} else{ $_1761518185= ArrayHelper::getByNestedKey($_2107821457, $_840782132);  ArrayHelper::setByNestedKey($_2107821457, $_678037132, $_1761518185);  ArrayHelper::unsetByNestedKey($_2107821457, $_840782132);}} protected function rewriteContextValue($_34787650, &$_2107821457, $_919216531, $_1761518185){ if($_34787650 === 'global'){ $_1688925901= $GLOBALS['____1992152945'][10]($_919216531); if(empty($_919216531)){ $GLOBALS[$_1688925901]= $_1761518185;} else{ $_2107821457=& $GLOBALS[$_1688925901]; ArrayHelper::setByNestedKey($_2107821457, $_919216531, $_1761518185);}} else{  ArrayHelper::setByNestedKey($_2107821457, $_919216531, $_1761518185);}} protected function unsetContextValue($_34787650, &$_2107821457, $_919216531){ if($_34787650 === 'global'){ $_1688925901= $GLOBALS['____1992152945'][11]($_919216531); if(empty($_919216531)){ unset($GLOBALS[$_1688925901]);} else{ $_2107821457=& $GLOBALS[$_1688925901]; ArrayHelper::unsetByNestedKey($_2107821457, $_919216531);}} else{ ArrayHelper::unsetByNestedKey($_2107821457, $_919216531);}}  protected function recursiveContextKeyHandle(string $_34787650, array &$_2107821457, array $_2009622553, Rule $_530258179): array{  $_315448752=[]; foreach($_2107821457 as $_354808898 => $_1761518185){ $_919216531= $GLOBALS['____1992152945'][12]($_2009622553,[$_354808898]); if($_530258179->matchKey($_919216531)){  if($_530258179->getProcess() === ___293823116(20)){ $_1180705614= $_530258179->evaluate($_354808898);} elseif($_530258179->getProcess() === ___293823116(21)){ $_1180705614= $_530258179->evaluateValue($_1761518185);}  if(!empty($_1180705614) && $_1180705614 instanceof RuleResult){ $_315448752[]= new HandlingResult($_34787650, $_919216531, $_1180705614, $_530258179);}}  if($GLOBALS['____1992152945'][13]($_1761518185)){ $_315448752= $GLOBALS['____1992152945'][14]($_315448752, $this->recursiveContextKeyHandle( $_34787650, $_2107821457[$_354808898], $_919216531, $_530258179));}} return $_315448752;} protected function getContextElements(array $_2056735331){ $_1275716787=[]; if($GLOBALS['____1992152945'][15](___293823116(22), $_2056735331, true)){ $_1275716787[___293823116(23)]= &$_GET;} if($GLOBALS['____1992152945'][16](___293823116(24), $_2056735331, true)){ $_1275716787[___293823116(25)]= &$_POST;} if($GLOBALS['____1992152945'][17](___293823116(26), $_2056735331, true)){ $_1275716787[___293823116(27)]= &$_COOKIE;} if($GLOBALS['____1992152945'][18](___293823116(28), $_2056735331, true)){ $_1275716787[___293823116(29)]= &$_REQUEST;} if($GLOBALS['____1992152945'][19](___293823116(30), $_2056735331, true)){ $_1275716787[___293823116(31)]= $GLOBALS;} return $_1275716787;} public static function refreshRules(){ try{ $_541802631= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1992152945'][20]()- $_541802631)< static::CACHE_RULES_TTL){ return;} Option::set(___293823116(32), ___293823116(33), $GLOBALS['____1992152945'][21]()); $_1574868327= null;  $_453720881= $GLOBALS['____1992152945'][22](function($_1303779363){ return[___293823116(34) => $_1303779363[___293823116(35)], ___293823116(36) => (int) $_1303779363[___293823116(37)]];}, ModuleManager::getModulesFromDisk());  $_639425921=[]; foreach($GLOBALS['____1992152945'][23]() as $_1358031896){ $_491797472= new ReflectionExtension($_1358031896); $_639425921[$_1358031896]=[ ___293823116(38) => $_491797472->getVersion(), ___293823116(39) => $_491797472->getINIEntries()];} $_1139911820=[ ___293823116(40) => $GLOBALS['____1992152945'][24]($_453720881), ___293823116(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___293823116(42) => $GLOBALS['____1992152945'][25]([ ___293823116(43) => $GLOBALS['____1992152945'][26](), ___293823116(44) => $_639425921])]; if(Loader::includeModule(___293823116(45))){ $_1173649384= CSecuritySystemInformation::getSystemInformation(); if(isset($_1173649384[___293823116(46)][___293823116(47)]) && isset($_1173649384[___293823116(48)][___293823116(49)])){ $_1139911820[___293823116(50)]=[ ___293823116(51) => $_1173649384[___293823116(52)][___293823116(53)], ___293823116(54) => $_1173649384[___293823116(55)][___293823116(56)]];} if(isset($_1173649384[___293823116(57)][___293823116(58)])){ $_1139911820[___293823116(59)]=[___293823116(60) => $_1173649384[___293823116(61)][___293823116(62)]];}}  $_464448791= new HttpClient([ ___293823116(63) => round(0+1.25+1.25+1.25+1.25), ___293823116(64) => round(0+2.5+2.5)]); $_1863980545= $_464448791->post( static::$_453572466, $_1139911820); if($_464448791->getStatus() == round(0+100+100) &&!empty($_1863980545)){ $_1574868327= Json::decode($_1863980545);}  if($_1574868327 !== null){ $_326105303= Application::getConnection(); $_1908957546= RuleRecordTable::getTableName(); if(!empty($_1574868327)){ foreach($_1574868327 as $_2112917778){ if(!static::checkRuleSign($_2112917778)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1992152945'][27]($_2112917778));}}}  $_326105303->truncateTable($_1908957546);  if(!empty($_1574868327)){ $_1944194740=[]; foreach($_1574868327 as $_2112917778){ $_1944194740[]= ___293823116(65). $_326105303->getSqlHelper()->forSql($_2112917778[___293823116(66)]). ___293823116(67). $_326105303->getSqlHelper()->forSql($_2112917778[___293823116(68)]). ___293823116(69). $_326105303->getSqlHelper()->forSql($_2112917778[___293823116(70)]). ___293823116(71);} $_1614058315= $GLOBALS['____1992152945'][28](___293823116(72), $_1944194740);  $_326105303->query("INSERT INTO {$_1908957546} (DATA, MODULE, MODULE_VERSION) VALUES {$_1614058315}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1210173245){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___293823116(73), ___293823116(74), ___293823116(75), ___293823116(76). $_1210173245->getMessage(). ___293823116(77). $_1210173245->getTraceAsString());}} protected static function checkRuleSign($_530258179){ $_2025186515= new PublicKeyCipher; $_2146206264= $_2025186515->decrypt($_530258179[___293823116(78)], static::__1811854996()); return str_starts_with($_2146206264, ___293823116(79));} private static function __1811854996(){ $_1381683450= ''; $_1381683450 .= ___293823116(80); $_1381683450 .= ___293823116(81); return $_1381683450;} protected function logEvent($_1901881536, $_905839817, $_1417045309){ if($this->_1123997673){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1901881536, 'main', $_905839817, $_1417045309);}}}?>